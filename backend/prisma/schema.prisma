generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User roles in the system
enum Role {
  STUDENT
  ADMIN
  MODERATOR
}

// Statuses that represent the state of a report during moderation
enum PostType {
  QUESTION
  NOTE
  RESOURCE
}

// Reports statuses
enum ReportStatus {
  PENDING
  REVIEWED
  DISMISSED
}

// Notification types for user alerts
enum NotificationType {
  COMMENT_ON_POST
  REPLY_TO_COMMENT
  LIKE
  REPORT_UPDATE
}

// Represents a user account with authentication and profile information
model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String   @unique
  password  String
  bio       String?
  role      Role     @default(STUDENT)
  createdAt DateTime @default(now()) @map("created_at")

  Avatar   Avatar? @relation(fields: [avatarId], references: [id])
  avatarId Int?    @map("avatar_id")

  posts                 Post[]
  comments              Comment[]
  likes                 Like[]
  bookmarks             Bookmark[]
  mentionedInComments   Comment[]      @relation("mentionedUser")
  reports               Report[]
  notifications         Notification[] @relation("notificationActor")
  notificationsReceived Notification[] @relation("notificationReceiver")

  @@map("users")
}

// Represents a profile avatar that users can be assigned or choose
model Avatar {
  id        Int     @id @default(autoincrement())
  url       String  @unique
  isDefault Boolean @default(false) @map("is_default")
  users     User[]

  @@map("avatars")
}

// Represents a post created by a user (question, note, or resource)
model Post {
  id      String   @id @default(uuid())
  title   String
  content String?
  type    PostType
  hidden  Boolean  @default(false)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  author   User   @relation(fields: [authorId], references: [id])
  authorId String @map("author_id")

  // Resource-specific fields
  fileUrl  String? @map("file_url")
  fileName String? @map("file_name")
  fileSize Int?    @map("file_size")
  mimeType String? @map("mime_type")

  comments      Comment[]
  likes         Like[]
  postTags      PostTag[]
  bookmarks     Bookmark[]
  reports       Report[]
  notifications Notification[]

  @@map("posts")
}

// Represents a comment made by a user on a post
model Comment {
  id        Int      @id @default(autoincrement())
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  hidden    Boolean  @default(false)

  parent   Comment? @relation("commentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  parentId Int?     @map("parent_id")

  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId String @map("post_id")

  author   User   @relation(fields: [authorId], references: [id])
  authorId String @map("author_id")

  mentionedUser   User?   @relation("mentionedUser", fields: [mentionedUserId], references: [id])
  mentionedUserId String? @map("mentioned_user_id")

  Comment       Comment[]      @relation("commentReplies")
  reports       Report[]
  notifications Notification[]

  @@map("comments")
}

// Represents a category or topic tag that can be attached to posts
model Tag {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  postTags PostTag[]

  @@map("tags")
}

// Junction table for many-to-many relationship between posts and tags
model PostTag {
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId String @map("post_id")
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId  Int    @map("tag_id")

  @@id([postId, tagId])
  @@map("post_tags")
}

// Represents a like/upvote/useful given by a user to a post
model Like {
  user   User   @relation(fields: [userId], references: [id])
  userId String @map("user_id")
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId String @map("post_id")

  @@id([userId, postId])
  @@map("likes")
}

// Represents a post bookmarked by a user
model Bookmark {
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @map("user_id")
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String   @map("post_id")
  createdAt DateTime @default(now()) @map("created_at")

  @@id([userId, postId])
  @@map("bookmarks")
}

// Predefined reasons that users can select when submitting a report
model ReportReason {
  id          Int      @id @default(autoincrement())
  label       String   @unique
  description String?
  active      Boolean  @default(true)
  reports     Report[]

  @@map("report_reasons")
}

// Represents a user-submitted report on a post or comment
model Report {
  id             Int          @id @default(autoincrement())
  status         ReportStatus @default(PENDING)
  moderatorNotes String?      @map("moderator_notes") // optional notes by admin/moderator
  createdAt      DateTime     @default(now()) @map("created_at")

  reporter   User   @relation(fields: [reporterId], references: [id])
  reporterId String @map("reporter_id")

  post   Post?   @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId String? @map("post_id")

  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  commentId Int?     @map("comment_id")

  reason   ReportReason @relation(fields: [reasonId], references: [id], onDelete: Cascade)
  reasonId Int          @map("reason_id")

  @@map("reports")
}

model Notification {
  id   Int              @id @default(autoincrement())
  type NotificationType
  read Boolean          @default(false)

  createdAt DateTime @default(now()) @map("created_at")

  // Receiver (who gets notified)
  user   User   @relation("notificationReceiver", fields: [userId], references: [id], onDelete: Cascade)
  userId String @map("user_id")

  // Actor (who triggered it)
  actor   User   @relation("notificationActor", fields: [actorId], references: [id])
  actorId String @map("actor_id")

  // Context (related post or comment)
  post      Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String?  @map("post_id")
  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  commentId Int?     @map("comment_id")

  @@map("notifications")
}
